name: Deploy WhoAmI

on:
  push:
    branches: [ "master", "main" ]
  workflow_dispatch:

jobs:
  deploy-app:
    runs-on: ubuntu-latest
    name: Deploy Application
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: LaunchPad Deploy
        uses: mieweb/launchpad@cmyers_issue3
        with:
          # --- API Config ---
          api_key: ${{ secrets.API_KEY }}
          api_url: ${{ secrets.API_URL }}
          github_pat: ${{ secrets.GH_PAT }}
          
          # --- Container Config ---
          template_name: "opensource-cmyers,101" 
          
          # 1. Install Go and Apache2
          install_command: "apt-get update && apt-get install -y golang apache2"
          
          # 2. Build the Go binary
          build_command: "go build -o whoami ."
          
          # 3. Configure Apache & Systemd
          # This script does 3 things:
          # A. Sets up Apache Reverse Proxy
          # B. Creates a Systemd service for the Go app (so it runs in background & restarts on crash)
          # C. Starts both services and EXITS cleanly so the deployment job succeeds.
          start_command: |
            # --- A. Apache Config ---
            a2enmod proxy proxy_http
            echo '<VirtualHost *:80>
                ProxyPreserveHost On
                ProxyPass / http://127.0.0.1:8080/
                ProxyPassReverse / http://127.0.0.1:8080/
            </VirtualHost>' > /etc/apache2/sites-available/000-default.conf

            # --- B. Systemd Service Config ---
            # We use $(pwd) to ensure it points to where the repo was cloned
            cat <<EOF > /etc/systemd/system/whoami.service
            [Unit]
            Description=WhoAmI Go App
            After=network.target

            [Service]
            Type=simple
            User=root
            WorkingDirectory=$(pwd)
            ExecStart=$(pwd)/whoami --port 8080
            Restart=always

            [Install]
            WantedBy=multi-user.target
            EOF

            # --- C. Start Services ---
            systemctl daemon-reload
            systemctl enable whoami
            systemctl restart whoami
            service apache2 restart
          
          runtime_language: "go"
          container_env_vars: '{"WHOAMI_NAME": "LaunchPad-Apache-Proxy"}'
          deploy_on_start: "true"
          container_domain: "meditation-products-acceptable-consultant.trycloudflare.com"