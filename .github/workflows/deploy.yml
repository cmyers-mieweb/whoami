name: Deploy WhoAmI

on:
  push:
    branches: [ "master", "main" ]
  workflow_dispatch:

jobs:
  deploy-app:
    runs-on: ubuntu-latest
    name: Deploy Application
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: LaunchPad Deploy
        uses: mieweb/launchpad@cmyers_issue3
        with:
          # --- API Config ---
          api_key: ${{ secrets.API_KEY }}
          api_url: ${{ secrets.API_URL }}
          github_pat: ${{ secrets.GH_PAT }}
          
          # --- Container Config ---
          template_name: "opensource-cmyers,101" 
          
          # 1. Install Go and Apache2
          install_command: "apt-get update && apt-get install -y golang apache2"
          
          # 2. Build the Go binary
          build_command: "go build -o whoami ."
          
          # 3. Configure Apache & Start App
          # This script does 4 things:
          # A. Enables Apache proxy modules
          # B. Configures Apache to listen on Port 80 and forward to Port 8080
          # C. Restarts Apache to apply changes
          # D. Starts the Go app on Port 8080 in the foreground (keeping the container alive)
          start_command: |
            a2enmod proxy proxy_http
            echo '<VirtualHost *:80>
                ProxyPreserveHost On
                ProxyPass / http://127.0.0.1:8080/
                ProxyPassReverse / http://127.0.0.1:8080/
            </VirtualHost>' > /etc/apache2/sites-available/000-default.conf
            service apache2 restart
            ./whoami --port 8080
          
          runtime_language: "go"
          container_env_vars: '{"WHOAMI_NAME": "LaunchPad-Apache-Proxy"}'
          deploy_on_start: "true"
          container_domain: "sequence-column-contributor-floors.trycloudflare.com"